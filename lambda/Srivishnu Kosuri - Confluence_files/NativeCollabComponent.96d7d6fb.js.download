var e=globalThis;function t(e){return e&&e.__esModule?e.default:e}var i=e.parcelRequired477,s=i.register;s("eOOPa",function(s,r){var n,a,o,c,d,h,l,p,u,m,E=i("dQl1W"),S=i("majy4");class g{emit(e,t){return this.eventEmitter.emit(e,t),this}on(e,t){return this.eventEmitter.on(e,t),this}off(e,t){return this.eventEmitter.off(e,t),this}unsubscribeAll(e){return this.eventEmitter.removeAllListeners(e),this}constructor(){this.eventEmitter=new(0,S.EventEmitter2)}}var f=i("dwp40"),v=((n={}).SOCKET_CONNECT="socketConnect",n.DOCUMENT_INIT="documentInit",n.COMMIT_UNCONFIRMED_STEPS="commitUnconfirmedSteps",n.PUBLISH_PAGE="publishPage",n.GET_CURRENT_STATE="getCurrentState",n);let I=()=>"undefined"!=typeof window&&"performance"in window&&["measure","clearMeasures","clearMarks","getEntriesByName","getEntriesByType"].every(e=>!!performance[e]),y=new Map;function C(e,t){try{if(!I())return;performance.mark(`${e}::start`),y.set(e,performance.now())}catch(e){t?.sendErrorEvent(e,"Error while measuring performance when marking the start")}}function R(e,t,i){let s;try{if(!I()||!y.get(e))return;performance.mark(`${e}::end`),s=i?y.get(e):void 0,performance.measure(e,`${e}::start`,`${e}::end`)}catch(e){t?.sendErrorEvent(e,"Error while measuring performance when marking the end")}try{var r;let t,n=performance.getEntriesByName(e).pop();return r=e,I()&&(y.delete(r),performance.clearMarks(`${r}::start`),performance.clearMarks(`${r}::end`),performance.clearMeasures(r)),n?t={duration:n.duration,startTime:n.startTime}:s&&(t={duration:performance.now()-s,startTime:s}),t&&i&&i(t.duration,t.startTime),t}catch(e){t?.sendErrorEvent(e,"Error while measuring performance when completing the measurement")}}let T=()=>1e-4>Math.random();var A=((a={}).CONNECTION="connection",a.CATCHUP="catchup",a.DOCUMENT_INIT="documentInit",a.ADD_STEPS="addSteps",a.UPDATE_PARTICIPANTS="updateParticipants",a.UPDATE_DOCUMENT="updateDocument",a.COMMIT_UNCONFIRMED_STEPS="commitUnconfirmedSteps",a.REINITIALISE_DOCUMENT="reinitialiseDocument",a.ERROR="error",a.PUBLISH_PAGE="publishPage",a.GET_CURRENT_STATE="getCurrentState",a.INVALIDATE_TOKEN="invalidateToken",a.SEND_STEPS_RETRY="sendStepsRetry",a.CATCHUP_AFTER_MAX_SEND_STEPS_RETRY="catchupAfterMaxSendStepsRetry",a.DROPPED_STEPS="droppedStepInCatchup",a.WEBSOCKET_MESSAGE_VOLUME_METRIC="websocketMessageVolumeMetric",a.PROVIDER_INITIALIZED="providerInitialized",a.RECONNECTION="providerReconnection",a.PROVIDER_SETUP="providerSetup",a.HAS_UNCONFIRMED_STEPS="hasUnconfirmedSteps",a.OUT_OF_SYNC="outOfSync",a.STEPS_REBASED="stepsRebased",a.POLLING_FALLBACK="pollingFallback",a.PROCESS_STEPS="processSteps",a),O=((o={}).SUCCESS="SUCCESS",o.FAILURE="FAILURE",o.INFO="INFO",o.SUCCESS_10x_SAMPLED="SUCCESS_10x_SAMPLED",o),_=((c={}).ACCEPTED="ACCEPTED",c.REJECTED="REJECTED",c.ERROR="ERROR",c),N=((d={}).STEPS_ADDED="onStepsAdded",d.STEPS_REJECTED="onStepsRejected",d.PROCESS_STEPS="processSteps",d.RECONNECTED="reconnected",d),P=((h={}).ONLINE="ONLINE",h.OFFLINE="OFFLINE",h);class w{getStatus(){return this.status||null}destroy(){window.removeEventListener("offline",this.offlineHandler),window.removeEventListener("online",this.onlineHandler)}constructor(e){this.status=void 0,this.onlineCallback=void 0,this.offlineHandler=()=>{this.status="OFFLINE"},this.onlineHandler=()=>{this.status="ONLINE",this.onlineCallback&&this.onlineCallback()},e?.initialStatus&&(this.status=e.initialStatus),e?.onlineCallback&&(this.onlineCallback=e.onlineCallback),"undefined"!=typeof window&&(window.addEventListener("offline",this.offlineHandler),window.addEventListener("online",this.onlineHandler))}}let D=new w({initialStatus:P.ONLINE});class b{countReconnectError(){D.getStatus()===P.OFFLINE&&this.failedReconnectCount++}isLikelyNetworkIssue(){return this.failedReconnectCount>=8}destroy(){window.removeEventListener("online",this.onlineHandler)}constructor(){this.failedReconnectCount=0,this.onlineHandler=()=>{this.failedReconnectCount=0},window.addEventListener("online",this.onlineHandler)}}let U=()=>new(0,i("4SCyD").UFOExperience)("collab-provider.document-init",{type:i("iqaft").ExperienceTypes.Load,performanceType:i("iqaft").ExperiencePerformanceTypes.Custom,performanceConfig:{histogram:{[i("iqaft").ExperiencePerformanceTypes.Custom]:{duration:"250_500_1000_1500_2000_3000_4000"}}}}),k=(e,t)=>{let i;try{i=e()}catch(e){t?.sendErrorEvent(e,"Error while initialising a UFO experience")}return i},M=e=>k(U,e),L={IO_CLIENT_DISCONNECT:"io client disconnect",IO_SERVER_DISCONNECT:"io server disconnect",TRANSPORT_CLOSED:"transport close",TRANSPORT_ERROR:"transport error",PING_TIMEOUT:"ping timeout"},H=e=>{switch(e){case L.IO_CLIENT_DISCONNECT:return i("h3X17").DisconnectReason.CLIENT_DISCONNECT;case L.IO_SERVER_DISCONNECT:return i("h3X17").DisconnectReason.SERVER_DISCONNECT;case L.TRANSPORT_CLOSED:return i("h3X17").DisconnectReason.SOCKET_CLOSED;case L.TRANSPORT_ERROR:return i("h3X17").DisconnectReason.SOCKET_ERROR;case L.PING_TIMEOUT:return i("h3X17").DisconnectReason.SOCKET_TIMEOUT;default:return i("h3X17").DisconnectReason.UNKNOWN_DISCONNECT}};var F=((l={}).TOKEN_PERMISSION_ERROR="TOKEN_PERMISSION_ERROR",l.RECONNECTION_NETWORK_ISSUE="RECONNECTION_NETWORK_ISSUE",l.CONNECTION_ERROR="CONNECTION_ERROR",l.RECONNECTION_ERROR="RECONNECTION_ERROR",l.DOCUMENT_NOT_FOUND="DOCUMENT_NOT_FOUND",l.CATCHUP_FAILED="CATCHUP_FAILED",l.DOCUMENT_RESTORE_ERROR="DOCUMENT_RESTORE_ERROR",l.ADD_STEPS_ERROR="ADD_STEPS_ERROR",l.DOCUMENT_UPDATE_ERROR="DOCUMENT_UPDATE_ERROR",l.VIEW_ONLY_STEPS_ERROR="VIEW_ONLY_STEPS_ERROR",l.OUT_OF_SYNC_CLIENT_DATA_LOSS_EVENT="OUT_OF_SYNC_CLIENT_DATA_LOSS_EVENT",l),x=((p={}).HEAD_VERSION_UPDATE_FAILED="HEAD_VERSION_UPDATE_FAILED",p.VERSION_NUMBER_ALREADY_EXISTS="VERSION_NUMBER_ALREADY_EXISTS",p.INSUFFICIENT_EDITING_PERMISSION="INSUFFICIENT_EDITING_PERMISSION",p.FORBIDDEN_USER_TOKEN="FORBIDDEN_USER_TOKEN",p.DOCUMENT_NOT_FOUND="DOCUMENT_NOT_FOUND",p.INIT_DATA_LOAD_FAILED="INIT_DATA_LOAD_FAILED",p.ERROR_MAPPING_ERROR="ERROR_MAPPING_ERROR",p.NAMESPACE_INVALID="NAMESPACE_INVALID",p.NAMESPACE_NOT_FOUND="NAMESPACE_NOT_FOUND",p.TENANT_INSTANCE_MAINTENANCE="TENANT_INSTANCE_MAINTENANCE",p.LOCKED_DOCUMENT="LOCKED_DOCUMENT",p.EMPTY_BROADCAST="EMPTY_BROADCAST",p.DYNAMO_ERROR="DYNAMO_ERROR",p.INVALID_ACTIVATION_ID="INVALID_ACTIVATION_ID",p.INVALID_DOCUMENT_ARI="INVALID_DOCUMENT_ARI",p.INVALID_CLOUD_ID="INVALID_CLOUD_ID",p.RATE_LIMIT_ERROR="RATE_LIMIT_ERROR",p.PROSEMIRROR_SCHEMA_VALIDATION_ERROR="PROSEMIRROR_SCHEMA_VALIDATION_ERROR",p);let V=(0,i("4frCv").createLogger)("Channel","green");class z extends g{connect(e=!1){let t;C(v.SOCKET_CONNECT,this.analyticsHelper),e&&(this.initialized=!0),this.initialized||(C(v.DOCUMENT_INIT,this.analyticsHelper),this.initExperience?.start());let{documentAri:i,url:s,path:r,createSocket:n,permissionTokenRefresh:a}=this.config;t=a?async e=>{let t={initialized:this.initialized,need404:this.config.need404};try{let i=await a();i?t.token=i:t.token=void 0,e(t)}catch(t){let e={message:"Insufficient editing permissions",data:{status:403,code:F.TOKEN_PERMISSION_ERROR,meta:{originalError:t,reason:t?.data?.meta?.reason}}};this.emit("error",e)}}:async e=>{e({initialized:this.initialized,need404:this.config.need404})},this.socket=n(`${s}/session/${i}`,t,this.config.productInfo,this.config.isPresenceOnly,this.analyticsHelper,r),this.socket.on("connect",this.onConnect),this.socket.on("data",this.onReceiveData),this.socket.on("permission",e=>{this.emit("permission",e)}),this.socket.on("steps:added",e=>{this.emit("steps:added",e)}),this.socket.on("participant:telepointer",({timestamp:e,data:t})=>{this.emit("participant:telepointer",{timestamp:e,...t})}),this.socket.on("presence:joined",e=>{this.emit("presence:joined",e)}),this.socket.on("presence",e=>{this.emit("presence",e)}),this.socket.on("participant:left",e=>{this.emit("participant:left",e)}),this.socket.on("participant:updated",({sessionId:e,timestamp:t,data:i,clientId:s})=>{this.emit("participant:updated",{sessionId:e,timestamp:t,clientId:s,...i})}),this.socket.on("metadata:changed",e=>{this.emit("metadata:changed",e)}),this.socket.on("status",e=>{this.emit("status",e)}),this.socket.on("disconnect",async e=>{if(this.connected=!1,V(`disconnect reason: ${e}`),this.emit("disconnect",{reason:e}),e===L.IO_SERVER_DISCONNECT&&this.socket)try{this.socket.connect()}catch(t){this.analyticsHelper?.sendErrorEvent(t,"Error while reconnecting the channel");let e={message:"Caught error during reconnection",data:{status:500,code:F.RECONNECTION_ERROR}};this.emit("error",e)}}),this.socket.on("error",e=>{this.emit("error",e)}),this.socket.on("connect_error",this.onConnectError),this.socket.on("permission:invalidateToken",this.handlePermissionInvalidateToken),this.socket.onAnyOutgoing((e,...t)=>this.onAnyOutgoingHandler(Date.now(),t)),this.network||(this.network=new w({onlineCallback:this.onOnlineHandler})),this.reconnectHelper=new b,this.socket.io.on("reconnect_error",this.onReconnectError),this.addVisiblityListener()}onAnyOutgoingHandler(e,t){let i=this.config.rateLimitType||this.RATE_LIMIT_TYPE_NONE;if(i===this.RATE_LIMIT_TYPE_NONE)return;let s=this.config.rateLimitStepCount||0,r=this.config.rateLimitTotalStepSize||0,n=this.config.rateLimitMaxStepSize||0;for(let a of t)if("steps:commit"===a.type){for(let t of(e-this.rateLimitWindowStartMs>this.rateLimitWindowDurationMs&&(this.rateLimitWindowStartMs=e,this.stepCounter=0,this.stepSizeCounter=0,this.maxStepSize=0),this.stepCounter+=a.steps.length,a.steps)){let e=JSON.stringify(t).length;this.stepSizeCounter+=e,e>this.maxStepSize&&(this.maxStepSize=e)}if(this.isLimitExceeded(s,r,n)){let e={message:"Rate limited",data:{code:x.RATE_LIMIT_ERROR,status:500,meta:{rateLimitType:i,maxStepSize:this.maxStepSize,stepSizeCounter:this.stepSizeCounter,stepCounter:this.stepCounter}}};if(i===this.RATE_LIMIT_TYPE_HARD)throw this.emit("error",e),Error();i===this.RATE_LIMIT_TYPE_SOFT&&this.analyticsHelper?.sendErrorEvent(e,"Rate limited")}}}async commonHeaders(){return{...this.config.permissionTokenRefresh?{"x-token":await this.getChannelToken()}:{},"x-product":(0,i("4frCv").getProduct)(this.config.productInfo),"x-subproduct":(0,i("4frCv").getSubProduct)(this.config.productInfo)}}isLimitExceeded(e,t,i){return e>0&&this.stepCounter>e||t>0&&this.stepSizeCounter>t||i>0&&this.maxStepSize>i}addVisiblityListener(){this.config.isPresenceOnly&&(this.unbindVisibilityListener=(0,i("fFa3V").bind)(document,{type:"visibilitychange",listener:()=>{this.disconnectTimer=this.autoDisconnect(this.disconnectTimer,60)}}))}disconnect(){this.unsubscribeAll(),this.cleanupAutoDisconnect(),this.network?.destroy(),this.network=null,this.socket&&(this.socket.close(),this.socket=null,this.reconnectHelper?.destroy())}constructor(e,t){super(),this.RATE_LIMIT_TYPE_NONE=0,this.RATE_LIMIT_TYPE_SOFT=1,this.RATE_LIMIT_TYPE_HARD=2,this.connected=!1,this.config=void 0,this.socket=null,this.reconnectHelper=null,this.initialized=!1,this.analyticsHelper=void 0,this.initExperience=void 0,this.token=void 0,this.network=null,this.disconnectTimer=void 0,this.rateLimitWindowDurationMs=6e4,this.rateLimitWindowStartMs=0,this.stepCounter=0,this.stepSizeCounter=0,this.maxStepSize=0,this.getInitialized=()=>this.initialized,this.getConnected=()=>this.connected,this.getSocket=()=>this.socket,this.getToken=()=>this.token,this.getChannelToken=async()=>this.token?this.token:this.config.permissionTokenRefresh?await this.config.permissionTokenRefresh()??void 0:void 0,this.handlePermissionInvalidateToken=e=>{V("Received permission invalidate event ",e),this.analyticsHelper?.sendActionEvent(A.INVALIDATE_TOKEN,O.SUCCESS,{reason:e.reason,usedCachedToken:!!this.token})},this.onConnectError=e=>{let t=R(v.SOCKET_CONNECT,this.analyticsHelper);this.analyticsHelper?.sendActionEvent(A.CONNECTION,O.FAILURE,{latency:t?.duration,usedCachedToken:!!this.token}),this.analyticsHelper?.sendErrorEvent(e,"Error while establishing connection");let i=e.data;i&&this.socket?.close();let s={message:e.message??"Connection error without message",data:{code:i?.code??F.CONNECTION_ERROR,...i}};this.emit("error",s)},this.onReconnectError=e=>{if(this.reconnectHelper?.countReconnectError(),this.reconnectHelper?.isLikelyNetworkIssue()){this.analyticsHelper?.sendErrorEvent(e,"Likely network issue while reconnecting the channel");let t={message:"Reconnection failed 8 times when browser was offline, likely there was a network issue",data:{code:F.RECONNECTION_NETWORK_ISSUE}};this.emit("error",t)}},this.onConnect=()=>{this.connected=!0,V("Connected.",this.socket.id);let e=R(v.SOCKET_CONNECT,this.analyticsHelper);this.analyticsHelper?.sendActionEvent(A.CONNECTION,O.SUCCESS,{latency:e?.duration,usedCachedToken:!!this.token}),this.emit("connected",{sid:this.socket.id,initialized:this.initialized})},this.onReceiveData=e=>{if(V("Received data",e),V("Session ID is",this.socket.id),"initial"===e.type)if(this.initialized){let{doc:t,version:i,userId:s,metadata:r,targetClientId:n}=e;this.emit("restore",{doc:t,version:i,userId:s,metadata:r,targetClientId:n})}else{let{doc:t,version:i,userId:s,metadata:r}=e,n=R(v.DOCUMENT_INIT,this.analyticsHelper);this.initExperience?.success(),this.analyticsHelper?.sendActionEvent(A.DOCUMENT_INIT,O.SUCCESS,{latency:n?.duration,resetReason:e.resetReason,hasTitle:!!e.metadata?.title}),this.initialized=!0,this.emit("init",{doc:t,version:i,userId:s,metadata:r})}else this.emit("steps:added",e)},this.fetchCatchupv2=async(e,t,i,s,r)=>{try{let{steps:n,metadata:a}=await f.utils.requestService(this.config,{path:`document/${encodeURIComponent(this.config.documentAri)}/catchupv2`,queryParams:{version:e,clientId:t,catchUpOutofSync:i,reason:s,sessionId:r},requestInit:{headers:await this.commonHeaders()}});return{steps:n,metadata:a}}catch(t){if(404===t.code){let e={message:"The requested document is not found",data:{status:t.code,code:F.DOCUMENT_NOT_FOUND}};return this.emit("error",e),{}}V("Can't fetch the catchupv2",t.message);let e={message:"Cannot fetch catchupv2 from collab service",data:{status:t.status,code:F.CATCHUP_FAILED}};throw this.emit("error",e),t}},this.fetchReconcile=async(e,t)=>{try{let i=JSON.stringify({doc:e,productId:"ccollab",reason:t});return await f.utils.requestService(this.config,{path:`document/${encodeURIComponent(this.config.documentAri)}/reconcile`,requestInit:{headers:{...await this.commonHeaders(),"Content-Type":"application/json"},method:"POST",body:i}})}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while fetching reconciled document"),e}},this.fetchGeneratedDiffSteps=async(e,t)=>{try{let i=JSON.stringify({doc:e,productId:"ccollab",reason:t});return await f.utils.requestService(this.config,{path:`document/${encodeURIComponent(this.config.documentAri)}/generate-diff-steps`,requestInit:{headers:{...await this.commonHeaders(),"Content-Type":"application/json"},method:"POST",body:i}})}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while fetching generated steps from the BE server"),e}},this.broadcast=(e,t,s)=>{if(!this.socket)throw new(0,i("ixa9X").NotInitializedError)("Cannot broadcast, not initialized yet");if(!this.connected){if(this.config.throwOnNotConnected)throw new(0,i("ixa9X").NotConnectedError)("Cannot broadcast, currently offline.");return}this.socket.emit("broadcast",{type:e,...t},s)},this.sendMetadata=e=>{if(!this.socket)throw new(0,i("ixa9X").NotInitializedError)("Cannot send metadata, not initialized yet");if(!this.connected&&this.config.throwOnNotConnected)throw new(0,i("ixa9X").NotConnectedError)("Cannot send metadata, currently offline.");this.socket.emit("metadata",e)},this.sendPresenceJoined=()=>{this.connected&&this.socket&&this.socket.emit("presence:joined")},this.onOnlineHandler=()=>{this.connected||(this.socket?.close(),this.socket?.connect())},this.cleanupAutoDisconnect=()=>{this.unbindVisibilityListener(),this.disconnectTimer&&(clearTimeout(this.disconnectTimer),this.disconnectTimer=void 0)},this.unbindVisibilityListener=()=>{},this.autoDisconnect=(e,t)=>{if(document.hidden)return V("visibilitychange: hidden"),setTimeout(()=>{V("visibilitychange: closing connection"),this.socket?.close()},t||0===t?1e3*t:6e4);V("visibilitychange: visible"),e&&clearTimeout(e),V("visibilitychange: re-connecting"),this.socket?.connect()},this.config=e,this.analyticsHelper=t,this.initExperience=M(this.analyticsHelper)}}var B=i("iu6m9");let q=["RangeError","TypeError","TransformError","NodeNestingTransformError"];var X=((u=X||{}).NCS="ncs",u.SYNCHRONY="synchrony",u);let $=(e,t)=>{if(!t)return;let i={actionSubject:"collab",attributes:{packageName:"platform-pkg",packageVersion:"0.0.0-use.local",collabService:"ncs",network:{status:D.getStatus()},...e.attributes},tags:["editor"],action:e.eventAction,source:"unknown"};if(e.eventAction===A.ERROR){i.nonPrivacySafeAttributes=e.nonPrivacySafeAttributes;try{let e=window.requestIdleCallback;("function"==typeof e?e:window.requestAnimationFrame)(()=>{t.sendTrackEvent(i)})}catch(e){}}else try{let e=window.requestIdleCallback;("function"==typeof e?e:window.requestAnimationFrame)(()=>{t.sendOperationalEvent(i)})}catch(e){}};class G{sendErrorEvent(e,t){let s={};e instanceof i("ixa9X").CustomError&&(s=e.getExtraErrorEventAttributes()||{});let r={eventAction:A.ERROR,attributes:{documentAri:this.documentAri,subProduct:this.subProduct,errorMessage:t,errorName:e instanceof Error?e.name:void 0,errorCode:e.data?.code??void 0,errorStatus:e.data?.status??void 0,errorStack:e instanceof Error&&q.includes(e.name)?e.stack:void 0,originalErrorMessage:this.getUGCFreeErrorMessage(e),...s},nonPrivacySafeAttributes:{error:e}};this.sendEvent(r)}sendProviderErrorEvent(e){let t={eventAction:A.ERROR,attributes:{documentAri:this.documentAri,subProduct:this.subProduct,errorMessage:"Error emitted",originalErrorMessage:e.message,errorCode:e.code,mappedError:e}};this.sendEvent(t)}sendActionEvent(e,t,i){let s={eventAction:e,attributes:{documentAri:this.documentAri,subProduct:this.subProduct,eventStatus:t,...i}};this.sendEvent(s)}async sendEvent(e){if(this.getAnalyticsClient&&!this.analyticsClient)try{this.analyticsClient=await this.getAnalyticsClient}catch(e){}$(e,this.analyticsClient)}getUGCFreeErrorMessage(e){return e instanceof Error&&q.includes(e.name)?e.message:void 0}constructor(e,t,i,s){this.analyticsClient=void 0,this.getAnalyticsClient=void 0,this.documentAri=void 0,this.subProduct=void 0,this.documentAri=e,this.subProduct=t,this.analyticsClient=i,this.getAnalyticsClient=s}}var j=((m={}).SUCCESS="SUCCESS",m.ERROR="ERROR",m);let J=(0,i("4frCv").createLogger)("Telepointer","green"),K=(e,t)=>{let[i]=e.filter(e=>e.clientId===t.clientId);if(i){let{stepType:e,to:s,from:r,slice:n={content:[]}}=t,[a]=n.content;if(s&&r&&"replace"===e&&s===r&&1===n.content.length&&a?.type==="text"&&a?.text?.length===1)return{sessionId:i.sessionId,selection:{type:"textSelection",anchor:r+1,head:s+1},type:"telepointer"}}},Y=e=>{let t=new(0,i("4SCyD").UFOExperience)("collab-provider.telepointer",{type:i("iqaft").ExperienceTypes.Operation,performanceType:i("iqaft").ExperiencePerformanceTypes.Custom,performanceConfig:{histogram:{[i("iqaft").ExperiencePerformanceTypes.Custom]:{duration:"250_500_1000_1500_2000_3000_4000"}}}});return t.addMetadata({documentAri:e}),t.start(),e=>{if(e.type===j.SUCCESS)t.success();else if(e.type===j.ERROR){let i=e.error;t.addMetadata({error:i}),J("Error from collab service with telepointer broadcast",i),t.failure()}else J("Invalid ACK from collab service with telepointer broadcast"),t.addMetadata({error:"Invalid ACK from collab service with telepointer broadcast"}),t.failure()}};var W=i("a4TK8");class Q{setTitle(e,t){t&&this.broadcastMetadata({title:e}),this.metadata.title=e}setEditorWidth(e,t){t&&this.broadcastMetadata({editorWidth:e}),this.metadata.editorWidth=e}constructor(e,i){this.providerEmitCallback=e,this.broadcastMetadata=i,this.metadata={},this.getMetaData=()=>this.metadata,this.getTitle=()=>this.metadata.title?.toString(),this.onMetadataChanged=e=>{void 0!==e&&!t(W)(this.metadata,e)&&Object.keys(e).length>0&&(this.metadata=e,this.providerEmitCallback("metadata:changed",e))},this.setMetadata=e=>{this.broadcastMetadata(e),this.metadata=e},this.updateMetadata=e=>{e&&Object.keys(e).length>0&&(this.metadata=e,this.providerEmitCallback("metadata:changed",e))}}}var Z=i("8Yfbq"),ee=i("1oCLl"),et={},ei=i("3PAnx"),es=i("77wHb"),er=Object.prototype.hasOwnProperty;et=es(function(e,t,i){er.call(e,i)?++e[i]:ei(e,i,1)});let en=(0,i("4frCv").createLogger)("commit-step","black");class ea{commitStepQueue({steps:e,version:t,userId:i,clientId:s,onStepsAdded:r,__livePage:n,hasRecovered:a,collabMode:o,reason:c,lockSteps:d,stepOrigins:h}){let l;if("publish"===c&&this.lastBroadcastRequestAcked&&(clearTimeout(l),d(),this.readyToCommit=!0),!this.readyToCommit)return void en("Not ready to commit, skip");this.readyToCommit=!1,this.lastBroadcastRequestAcked=!1;let p=setTimeout(()=>{d(),this.readyToCommit=!0,this.lastBroadcastRequestAcked=!0,en("reset readyToCommit by timer")},5e3),u=e.map(e=>({...e.toJSON(),clientId:s,userId:i}));n&&(u=u.map(e=>this.isExpandChangeStep(e)?{...e,attrs:{title:e.attrs.title}}:e)),a&&(u=u.map(e=>(e.metadata={...e.metadata,unconfirmedStepAfterRecovery:!0},e))),(0,ee.expValEquals)("platform_editor_offline_editing_web","isEnabled",!0)&&(u=this.addOfflineMetadata(u,h));let m=new Date().getTime(),E="Error while adding steps - Invalid Acknowledgement",S="Error while adding steps - Broadcast threw exception";this.emit("commit-status",{status:"attempt",version:t});try{this.broadcast("steps:commit",{collabMode:o,steps:u,version:t,userId:i},e=>{this.lastBroadcastRequestAcked=!0;let i=new Date().getTime()-m,s=i<680?680-i:1;e.delay&&(s=e.delay),clearTimeout(p),l=setTimeout(()=>{d(),this.readyToCommit=!0,en("reset readyToCommit")},s),e.type===j.SUCCESS?(r({steps:u,version:e.version}),this.sendSuccessAnalytics(i,u),this.emit("commit-status",{status:"success",version:e.version})):(e.type===j.ERROR?(this.onErrorHandled(e.error),this.sendFailureAnalytics(e,i)):this.analyticsHelper?.sendErrorEvent(Error(`Response type: ${e?.type||"No response type"}`),E),this.emit("commit-status",{status:"failure",version:t}),console.error(E))})}catch(e){d(),this.readyToCommit=!0,this.analyticsHelper?.sendErrorEvent(e,S),this.emit("commit-status",{status:"failure",version:t}),console.error(S)}}isExpandChangeStep(e){return"setAttrs"===e.stepType&&"__expanded"in e.attrs}addOfflineMetadata(e,t){return t.some(e=>!0===e.getMeta("isOffline")||!0===e.getMeta("wasOffline"))?e.map((e,i)=>{let s=t[i];if(!s)return e;let r=s.getMeta("isOffline")||s.getMeta("wasOffline");return!0===r&&(e.metadata={...e.metadata,createdOffline:r}),e}):e}sendSuccessAnalytics(e,i){.1>Math.random()&&this.analyticsHelper?.sendActionEvent(A.ADD_STEPS,O.SUCCESS_10x_SAMPLED,{type:_.ACCEPTED,latency:e,stepType:t(et)(i,e=>e.stepType)})}sendFailureAnalytics(e,t){this.analyticsHelper?.sendActionEvent(A.ADD_STEPS,O.FAILURE,{type:e.error.data.code===x.HEAD_VERSION_UPDATE_FAILED||e.error.data.code===x.VERSION_NUMBER_ALREADY_EXISTS?_.REJECTED:_.ERROR,latency:t}),this.analyticsHelper?.sendErrorEvent(e.error,"Error while adding steps - Acknowledgement Error")}getReadyToCommitStatus(){return this.readyToCommit}constructor(e,t,i,s){this.broadcast=e,this.analyticsHelper=t,this.emit=i,this.onErrorHandled=s,this.readyToCommit=void 0,this.lastBroadcastRequestAcked=void 0,this.readyToCommit=!0,this.lastBroadcastRequestAcked=!0}}let eo=(0,i("4frCv").createLogger)("Catchupv2","red"),ec=async e=>{let t,i,s=e.getCurrentPmVersion();try{({steps:t,metadata:i}=await e.fetchCatchupv2(s,e.clientId,e.catchUpOutofSync,e.reason,e.sessionId))}catch(t){throw e.analyticsHelper?.sendErrorEvent(t,"Error while fetching catchupv2 from server"),eo("Fetch catchupv2 from server failed:",t.message),t}try{if(e.onCatchupComplete?.(t),!t||0===t.length)return e.updateMetadata(i),!1;let r={version:s+t.length,steps:t};e.onStepsAdded(r),e.updateMetadata(i);let n=!!(e.clientId&&eh(s,e.getCurrentPmVersion(),t,e.clientId));return n&&ed(t,e),n}catch(t){throw e.analyticsHelper?.sendErrorEvent(t,"Failed to apply catchupv2 result in the editor"),eo("Apply catchupv2 steps failed:",t.message),t}},ed=(e,t)=>{let s=t.getState?.();t.analyticsHelper?.sendActionEvent(A.OUT_OF_SYNC,O.FAILURE,{obfuscatedSteps:(0,i("4frCv").getObfuscatedSteps)(e),obfuscatedDoc:s?(0,i("4frCv").getDocAdfWithObfuscation)(s.doc):null,catchupReason:t.reason})},eh=(e,t,i,s)=>!!(e>=t&&i.some(e=>e.clientId!==s)),el=(0,i("4frCv").createLogger)("documentService-queue","black");class ep{queueSteps(e){el(`Queueing data for version "${e.version}".`);let t=[...this.queue,e].sort((e,t)=>e.version>t.version?1:-1);this.queue=t}constructor(){this.queuePaused=!1,this.queue=[],this.getQueue=()=>this.queue,this.filterQueue=e=>{this.queue=this.queue.filter(e)},this.isPaused=()=>this.queuePaused,this.pauseQueue=()=>{this.queuePaused=!0},this.resumeQueue=()=>{this.queuePaused=!1},this.shift=()=>this.queue.shift()}}let eu=e=>e.reduce((e,t)=>{let i=e[e.length-1];if(i){let s=i.merge(t);if(s)return e[e.length-1]=s,e}return e.concat(t)},[]);function em(e,t){let s=i("6rMOj").ChangeSet.create(e),r=e;return eu(t).forEach((e,t)=>{let i=e.apply(r);null===i.failed&&null!==i.doc&&(r=i.doc,s=s.addSteps(r,[e.getMap()],{step:t}))}),s}let eE=({localChanges:e,localDoc:t,remoteChanges:i,remoteDoc:s})=>{let r=[];return e.changes.forEach(e=>{i.changes.forEach(i=>{if(e.fromA>=i.fromA&&e.toA<=i.toA||i.fromA>=e.fromA&&i.toA<=e.toA||e.fromA>=i.fromA&&e.fromA<i.toA&&e.toA>i.toA||e.fromA<i.fromA&&e.toA>i.fromA&&e.toA<=i.toA||e.fromA===i.toA||i.fromA===e.toA){let n=s.slice(i.fromB,i.toB),a=0===n.size;r.push({from:Math.min(e.fromA,i.fromA),to:Math.max(e.toA,i.toA),local:t.slice(e.fromB,e.toB,!a),remote:n})}})}),r},eS=({localSteps:e,remoteSteps:t,tr:s})=>{let r=s.mapping.maps?.length,n=s.docs.length;(0,i("9NwnH").rebaseSteps)(e,t,s);let a=s.docs[n+e.length]??s.doc,o=s.docs[n+e.length+t.length]??s.doc;return{mapStart:r+e.length,originalDoc:a,remoteDoc:o}},eg=()=>{},ef=(0,i("4frCv").createLogger)("documentService","red");class ev{getVersionFromCollabState(e,t){let s=(0,i("9NwnH").getCollabState)(e);return s?void 0===s.version?(this.analyticsHelper?.sendErrorEvent(Error("Collab state missing version info when calling ProseMirror function"),`${t} called with collab state missing version info`),0):s.version:(this.analyticsHelper?.sendErrorEvent(Error("No collab state when calling ProseMirror function"),`${t} called without collab state`),0)}notifyReconnectionConflict(e){if((0,B.editorExperiment)("platform_editor_offline_editing_web",!1))return;let t=this.getState?.(),s=t?(0,i("9NwnH").getCollabState)(t)?.unconfirmed:void 0;if(e.length>0&&t&&s&&s.length>0){let{schema:r,tr:n}=t,a=function({localSteps:e,remoteSteps:t,tr:i}){let s=i.doc,{originalDoc:r,remoteDoc:n,mapStart:a}=eS({localSteps:e,remoteSteps:t,tr:i}),o=em(r,e.map(e=>e.step)),c=em(r,t),d=i.mapping.slice(a),h=eE({localChanges:o,localDoc:s,remoteDoc:n,remoteChanges:c}),l=e=>!!e,p=new Set;return{inserted:h.filter(e=>0!==e.remote.size).map(e=>({...e,from:d.map(e.from,-1),to:d.map(e.to)})).filter(e=>{let t=`${e.from}-${e.to}`;return!p.has(t)&&(p.add(t),l(e))}),deleted:h.filter(e=>0===e.remote.size).map(e=>({...e,from:d.map(e.from),to:d.map(e.to)})).filter(l)}}({localSteps:s,remoteSteps:e.map(e=>i("cO9ey").Step.fromJSON(r,e)),tr:n});(a.deleted.length>0||a.inserted.length>0)&&this.providerEmitCallback("data:conflict",{offlineDoc:t.doc,...a})}}processQueue(){if(this.stepQueue.isPaused())return void ef("Queue is paused. Aborting.");if(ef("Looking for processable data."),this.stepQueue.getQueue().length>0){let e=this.stepQueue.shift(),t=this.getCurrentPmVersion()+e.steps.length;e.version===t&&(ef("Applying data from queue!"),this.processSteps(e),this.processQueue())}}processSteps(e){let{version:t,steps:i}=e;if(ef(`Processing data. Version "${t}".`),i?.length)try{let e=i.map(({clientId:e})=>e);this.providerEmitCallback("data",{json:i,version:t,userIds:e}),this.stepRejectCounter=0,this.participantsService.emitTelepointersFromSteps(i),-1===e.indexOf(this.clientId)&&setTimeout(()=>this.sendStepsFromCurrentState(),100),this.analyticsHelper?.sendActionEvent(A.PROCESS_STEPS,O.SUCCESS)}catch(t){let e=this.isStepsFromNewClientIdForSameUserId(i);ef(`Processing steps failed with error: ${t}. Triggering catch up call.`),this.analyticsHelper?.sendErrorEvent(t,e?"Error while processing steps with new clientId":"Error while processing steps"),this.throttledCatchupv2(N.PROCESS_STEPS)}}getIsNamespaceLocked(){return this.isNameSpaceLocked()}setup({getState:e,onSyncUpError:t,clientId:i}){return this.getState=e,this.onSyncUpError=t||eg,this.clientId=i,this}sendStepsFromCurrentState(e,t){let i=this.getState?.();if(!i)return void this.analyticsHelper?.sendErrorEvent(Error("Editor state is undefined"),"sendStepsFromCurrentState called without state");this.send(null,null,i,e,t)}send(e,t,s,r,n){let a=(0,B.editorExperiment)("platform_editor_offline_editing_web",!0),o=(0,ee.expValEquals)("platform_editor_enable_single_player_step_merging","isEnabled",!0),c=o?this.getState?.()??s:s;if(a||o){let e=o&&!this.commitStepService.getReadyToCommitStatus();if(!this.getConnected()||e)return}let d=(0,i("9NwnH").sendableSteps)(c),h=this.getVersionFromCollabState(c,"collab-provider: send");if(!d)return;(a||o)&&this.lockStepOrigins(d.origins);let l=d.steps;if(r&&this.analyticsHelper?.sendActionEvent(A.HAS_UNCONFIRMED_STEPS,O.INFO,{numUnconfirmedSteps:l?.length||0}),!l?.length)return;let p=e?.getMeta("rebasedData");if(p){let e=this.obfuscateStepsAndState(p.unconfirmedSteps).obfuscatedSteps,t=this.obfuscateStepsAndState(p.remoteSteps),i=this.obfuscateStepsAndState(l).obfuscatedSteps;this.analyticsHelper?.sendActionEvent(A.STEPS_REBASED,O.INFO,{obfuscatedUnconfirmedSteps:e,obfuscatedRemoteSteps:t,obfuscatedRebasedSteps:i,clientID:this.clientId,userId:this.getUserId(),versionBefore:p.versionBefore,versionAfter:h})}if((0,B.editorExperiment)("platform_editor_offline_editing_web",!0)){if(d?.origins.some(e=>e instanceof i("ks2lK").Transaction&&(e.getMeta("isOffline")??!1))&&!this.timeoutExceeded){this.getConnected()&&!this.timeout&&(this.timeout=setTimeout(()=>{if(this.getConnected()){this.timeoutExceeded=!0;let e=(0,i("9NwnH").sendableSteps)(c);e?.origins.forEach(e=>{e instanceof i("ks2lK").Transaction&&e.getMeta("isOffline")&&e.setMeta("isOffline",!1)})}else this.timeout=void 0},6e3));return}this.timeoutExceeded&&(this.timeoutExceeded=!1,this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0))}this.commitStepService.commitStepQueue({userId:this.getUserId(),clientId:this.clientId,steps:l,version:h,onStepsAdded:this.onStepsAdded,__livePage:this.options.__livePage,hasRecovered:this.hasRecovered,collabMode:this.participantsService.getCollabMode(),reason:n,lockSteps:this.lockSteps,stepOrigins:d.origins})}constructor(e,s,r,n,a,o,c,d,h,l,p,u=!1,m={__livePage:!1},E){this.participantsService=e,this.analyticsHelper=s,this.fetchCatchupv2=r,this.fetchReconcile=n,this.fetchGeneratedDiffSteps=a,this.providerEmitCallback=o,this.broadcast=c,this.getUserId=d,this.metadataService=l,this.isNameSpaceLocked=p,this.enableErrorOnFailedDocumentApply=u,this.options=m,this.getConnected=E,this.getState=void 0,this.onSyncUpError=void 0,this.stepQueue=void 0,this.stepRejectCounter=0,this.aggressiveCatchup=!1,this.catchUpOutofSync=!1,this.hasRecovered=!1,this.commitStepService=void 0,this.timeout=void 0,this.timeoutExceeded=!1,this.clientId=void 0,this.onErrorHandled=void 0,this.throttledCatchupv2=t(Z)((e,t,i)=>this.catchupv2(e,t,i),1e3,{leading:!1,trailing:!0}),this.catchupv2=async(e,t,i)=>{let s=new Date().getTime();if(this.stepQueue.isPaused())return void ef("Queue is paused. Aborting.");if(this.isNameSpaceLocked())return void ef("catchupv2: Document is locked. Aborting.");this.stepQueue.pauseQueue();try{this.catchUpOutofSync=await ec({getCurrentPmVersion:this.getCurrentPmVersion,fetchCatchupv2:this.fetchCatchupv2,updateMetadata:this.metadataService.updateMetadata,analyticsHelper:this.analyticsHelper,clientId:this.clientId,onStepsAdded:this.onStepsAdded,catchUpOutofSync:this.catchUpOutofSync,reason:e,sessionId:i,onCatchupComplete:i=>{e===N.RECONNECTED&&(this.analyticsHelper?.sendActionEvent(A.RECONNECTION,O.INFO,{...t,remoteStepsLength:i?.length??0}),this.notifyReconnectionConflict(i))},getState:this.getState});let r=new Date().getTime()-s;this.analyticsHelper?.sendActionEvent(A.CATCHUP,O.SUCCESS,{latency:r,version:this.getCurrentPmVersion()})}catch(r){let i=new Date().getTime()-s;(r instanceof Error?r.message:String(r)).includes("TypeError")||r instanceof TypeError||this.analyticsHelper?.sendActionEvent(A.CATCHUP,O.FAILURE,{latency:i,reason:e,unconfirmedStepsLength:t?.unconfirmedStepsLength,disconnectionPeriodSeconds:t?.disconnectionPeriodSeconds})}finally{this.stepQueue.resumeQueue(),this.processQueue(),this.sendStepsFromCurrentState(),this.stepRejectCounter=0}},this.getCurrentPmVersion=()=>{let e=this.getState?.();return e?this.getVersionFromCollabState(e,"collab-provider: getCurrentPmVersion"):(this.analyticsHelper?.sendErrorEvent(Error("No editor state when calling ProseMirror function"),"getCurrentPmVersion called without state"),0)},this.getCurrentState=async()=>{try{C(v.GET_CURRENT_STATE,this.analyticsHelper),this.getState?.()||this.analyticsHelper?.sendErrorEvent(Error("Editor state is undefined"),"getCurrentState called without state");let e=this.getState(),t=new(0,i("h9yJL").JSONTransformer)().encode(e.doc),s=this.getVersionFromCollabState(e,"collab-provider: getCurrentState"),r={content:t,title:this.metadataService.getTitle(),stepVersion:s},n=R(v.GET_CURRENT_STATE,this.analyticsHelper);return this.analyticsHelper?.sendActionEvent(A.GET_CURRENT_STATE,O.SUCCESS,{latency:n?.duration}),r}catch(t){let e=R(v.GET_CURRENT_STATE,this.analyticsHelper);throw this.analyticsHelper?.sendActionEvent(A.GET_CURRENT_STATE,O.FAILURE,{latency:e?.duration}),this.analyticsHelper?.sendErrorEvent(t,"Error while returning ADF version of current draft document"),t}},this.isStepsFromNewClientIdForSameUserId=e=>{try{if(!Array.isArray(e)||0===e.length)return!1;if(!new Set(e.map(({clientId:e})=>e)).has(this.clientId)&&new Set(e.map(({userId:e})=>e)).has(this.getUserId()))return!0;return!1}catch(e){return this.analyticsHelper?.sendErrorEvent(e,"Error while checking for new clientId for same userId in steps"),!1}},this.getUnconfirmedStepsOrigins=()=>{let e=this.getState?.();return e?(0,i("9NwnH").sendableSteps)(e)?.origins:void this.analyticsHelper?.sendErrorEvent(Error("No editor state when calling ProseMirror function"),"getUnconfirmedStepsOrigins called without state")},this.getUnconfirmedSteps=()=>{let e=this.getState?.();return e?(0,i("9NwnH").sendableSteps)(e)?.steps:void this.analyticsHelper?.sendErrorEvent(Error("No editor state when calling ProseMirror function"),"getUnconfirmedSteps called without state")},this.applyLocalSteps=e=>{this.providerEmitCallback("local-steps",{steps:e})},this.onStepsAdded=e=>{if(ef("Received steps",{steps:e.steps,version:e.version}),!e.steps)return void ef("No steps.. waiting..");let t="Error while adding steps in the provider";try{let t=this.getCurrentPmVersion(),i=t+e.steps.length;e.version<=t?ef("Received steps we already have. Ignoring."):e.version===i?this.processSteps(e):e.version>i&&(ef(`Version too high. Expected "${i}" but got "${e.version}. Current local version is ${t}.`),this.stepQueue.queueSteps(e),this.throttledCatchupv2(N.STEPS_ADDED)),this.participantsService.updateLastActive(e.steps.map(({userId:e})=>e))}catch(e){this.analyticsHelper?.sendErrorEvent(e,t),this.onErrorHandled({message:t,data:{status:500,code:F.ADD_STEPS_ERROR}}),console.error(t)}},this.obfuscateStepsAndState=(e,t)=>{let s,r;try{s=e?(0,i("4frCv").getObfuscatedSteps)(e.map(e=>e.toJSON())):"None"}catch(e){s="Failed to obfuscate steps"}if(t)try{r=(0,i("4frCv").getDocAdfWithObfuscationFromJSON)(t.content)}catch(e){r="Failed to obfuscate doc"}return{obfuscatedSteps:s,obfuscatedDoc:r}},this.onRestore=async({doc:e,version:t,metadata:s,targetClientId:r})=>{if(r||(this.hasRecovered=!0),r&&this.clientId!==r)return;let n=this.getUnconfirmedSteps(),a=await this.getCurrentState(),o=!!(n?.length&&a&&!r),{obfuscatedSteps:c,obfuscatedDoc:d}=this.obfuscateStepsAndState(n,a);try{this.updateDocument({doc:e,version:t,metadata:s,reserveCursor:!0,caller:"onRestore"}),this.metadataService.updateMetadata(s);try{this.analyticsHelper?.sendActionEvent(A.REINITIALISE_DOCUMENT,O.INFO,{numUnconfirmedSteps:n?.length,obfuscatedSteps:c,obfuscatedDoc:d,hasTitle:!!s?.title,clientId:this.clientId,targetClientId:r,triggeredByCatchup:!!r}),n?.length&&this.applyLocalSteps(n)}catch(e){this.onErrorHandled({message:"Content synced with your team's edits. You may want to check for conflicting edits that could override your changes.",data:{code:F.OUT_OF_SYNC_CLIENT_DATA_LOSS_EVENT,meta:{reason:"fe-restore-fetch-generated-steps"}}}),o=!1;try{let{generatedSteps:e}=await this.fetchGeneratedDiffSteps(JSON.stringify(a.content),"fe-restore-fetch-generated-steps"),t=this.getState?.();if(t?.schema){let s=e?.map(e=>i("cO9ey").Step.fromJSON(t.schema,e));s&&s.length>0?(this.analyticsHelper?.sendActionEvent(A.REINITIALISE_DOCUMENT,O.INFO,{stepsCount:s.length}),this.applyLocalSteps(s)):this.analyticsHelper?.sendActionEvent(A.REINITIALISE_DOCUMENT,O.INFO,{reason:"fetchGeneratedDiffSteps returned no steps"})}}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error fetchGeneratedDiffSteps with steps-only mode")}}this.analyticsHelper?.sendActionEvent(A.REINITIALISE_DOCUMENT,O.SUCCESS,{numUnconfirmedSteps:n?.length,hasTitle:!!s?.title,useReconcile:o,clientId:this.clientId,targetClientId:r,triggeredByCatchup:!!r})}catch(e){this.analyticsHelper?.sendActionEvent(A.REINITIALISE_DOCUMENT,O.FAILURE,{numUnconfirmedSteps:n?.length,useReconcile:o,clientId:this.clientId,targetClientId:r,triggeredByCatchup:!!r}),this.analyticsHelper?.sendErrorEvent(e,`Error while reinitialising document. Use Reconcile: ${o}`),this.onErrorHandled({message:"Caught error while trying to recover the document",data:{status:500,code:F.DOCUMENT_RESTORE_ERROR}})}},this.getFinalAcknowledgedState=async e=>{this.aggressiveCatchup=!0;try{let t;C(v.PUBLISH_PAGE,this.analyticsHelper);try{await this.commitUnconfirmedSteps(e),t=await this.getCurrentState()}catch(s){let e=await this.getCurrentState(),i=await this.fetchReconcile(JSON.stringify(e.content),"fe-final-ack");t={content:JSON.parse(i.document),title:e.title,stepVersion:i.version}}let i=R(v.PUBLISH_PAGE,this.analyticsHelper);return this.analyticsHelper?.sendActionEvent(A.PUBLISH_PAGE,O.SUCCESS,{latency:i?.duration}),this.aggressiveCatchup=!1,t}catch(t){this.aggressiveCatchup=!1;let e=R(v.PUBLISH_PAGE,this.analyticsHelper);throw this.analyticsHelper?.sendActionEvent(A.PUBLISH_PAGE,O.FAILURE,{latency:e?.duration}),this.analyticsHelper?.sendErrorEvent(t,"Error while returning ADF version of the final draft document"),t}},this.updateDocument=({doc:e,version:t,metadata:i,reserveCursor:s,caller:r})=>{this.providerEmitCallback("init",{doc:e,version:t,metadata:i,...s?{reserveCursor:s}:{}}),this.updateDocumentAnalytics(e,t,r)},this.updateDocumentAnalytics=(e,t,s)=>{let r=this.getCurrentPmVersion(),n=this.validatePMJSONDocument(e);if(r<t){let a=new(0,i("ixa9X").UpdateDocumentError)("Failed to update the document",{newVersion:t,editorVersion:r,isDocTruthy:!!e,docHasContent:e?.content?.length>=1,isDocContentValid:n,caller:s});if(this.analyticsHelper?.sendErrorEvent(a,"Failed to update the document in document service"),this.enableErrorOnFailedDocumentApply)throw this.onErrorHandled({message:"The provider failed to apply changes to the editor",data:{code:F.DOCUMENT_UPDATE_ERROR,meta:{newVersion:t,editorVersion:r},status:500}}),a}else this.analyticsHelper?.sendActionEvent(A.UPDATE_DOCUMENT,O.SUCCESS,{newVersion:t,editorVersion:r,isDocTruthy:!!e,docHasContent:e?.content?.length>=1,isDocContentValid:n})},this.validatePMJSONDocument=e=>{try{this.getState?.()||this.analyticsHelper?.sendErrorEvent(Error("Editor state is undefined"),"validatePMJSONDocument called without state");let t=this.getState();return(e.content||[]).map(e=>t.schema.nodeFromJSON(e)).every(e=>{try{e.check()}catch(e){return!1}return!0})}catch(e){return!1}},this.commitUnconfirmedSteps=async e=>{let t=this.getUnconfirmedSteps();try{if(t?.length){C(v.COMMIT_UNCONFIRMED_STEPS,this.analyticsHelper);let e=0,s=this.getUnconfirmedStepsOrigins(),r=s?.[s.length-1],n=!1;for(this.getState?.()||this.analyticsHelper?.sendErrorEvent(Error("Editor state is undefined"),"commitUnconfirmedSteps called without state");!n;){this.sendStepsFromCurrentState(void 0,"publish"),await (0,i("4frCv").sleep)(500);let t=this.getUnconfirmedSteps();if(t?.length){let e=this.getUnconfirmedStepsOrigins();n=!e?.some(e=>e===r)}else n=!0;if(!n&&e++>=60){if(this.onSyncUpError){let i=this.getState(),s=this.getVersionFromCollabState(i,"collab-provider: commitUnconfirmedSteps");this.onSyncUpError({lengthOfUnconfirmedSteps:t?.length,tries:e,maxRetries:60,clientId:this.clientId,version:s})}let s=this.getUnconfirmedSteps()?.map(e=>(0,i("4frCv").getStepUGCFreeDetails)(e));throw new(0,i("ixa9X").CantSyncUpError)("Can't sync up with Collab Service: unable to send unconfirmed steps and max retry reached",{unconfirmedStepsInfo:s?JSON.stringify(s):"Unable to generate UGC removed step info"})}}let a=R(v.COMMIT_UNCONFIRMED_STEPS,this.analyticsHelper);this.analyticsHelper?.sendActionEvent(A.COMMIT_UNCONFIRMED_STEPS,O.SUCCESS,{latency:a?.duration,numUnconfirmedSteps:t?.length})}}catch(i){let e=R(v.COMMIT_UNCONFIRMED_STEPS,this.analyticsHelper);throw this.analyticsHelper?.sendActionEvent(A.COMMIT_UNCONFIRMED_STEPS,O.FAILURE,{latency:e?.duration,numUnconfirmedSteps:t?.length}),this.analyticsHelper?.sendErrorEvent(i,"Error while committing unconfirmed steps"),i}},this.onStepRejectedError=()=>{this.stepRejectCounter++,ef(`Steps rejected (tries=${this.stepRejectCounter})`),this.analyticsHelper?.sendActionEvent(A.SEND_STEPS_RETRY,O.INFO,{count:this.stepRejectCounter});let e=this.aggressiveCatchup?i("eOOPa").MAX_STEP_REJECTED_ERROR_AGGRESSIVE:i("eOOPa").MAX_STEP_REJECTED_ERROR;this.stepRejectCounter>=e?(ef(`The steps were rejected too many times (tries=${this.stepRejectCounter}, limit=${i("eOOPa").MAX_STEP_REJECTED_ERROR}). Trying to catch-up.`),this.analyticsHelper?.sendActionEvent(A.CATCHUP_AFTER_MAX_SEND_STEPS_RETRY,O.INFO),this.throttledCatchupv2(N.STEPS_REJECTED)):setTimeout(()=>this.sendStepsFromCurrentState(),1e3)},this.lockSteps=()=>{if((0,B.editorExperiment)("platform_editor_offline_editing_web",!0)||(0,ee.expValEquals)("platform_editor_enable_single_player_step_merging","isEnabled",!0)){let e=this.getState?.();e&&this.lockStepOrigins((0,i("9NwnH").sendableSteps)(e)?.origins??[])}},this.lockStepOrigins=e=>{e?.forEach(e=>{if(e instanceof i("ks2lK").Transaction)return e.setMeta("mergeIsLocked",!0)})},this.stepQueue=new ep,this.onErrorHandled=h,this.commitStepService=new ea(this.broadcast,this.analyticsHelper,this.providerEmitCallback,this.onErrorHandled)}}class eI{updateDocument(){}onRestore(){}onStepsAdded(){}onStepRejectedError(){}send(){}sendStepsFromCurrentState(){}throttledCatchupv2(){}getCurrentState(){return Promise.resolve({})}getFinalAcknowledgedState(e){return Promise.resolve({})}getIsNamespaceLocked(){return!1}getUnconfirmedSteps(){}getUnconfirmedStepsOrigins(){}getCurrentPmVersion(){return -1}constructor(){this.setup=()=>this,this.onErrorHandled=()=>{}}}let ey=(0,i("4frCv").createLogger)("Provider","orange");class eC{constructor(e=!1){this.isNamespaceLocked=e,this.getIsNamespaceLocked=()=>this.isNamespaceLocked,this.onNamespaceStatusChanged=async({isLocked:e,waitTimeInMs:t,timestamp:i})=>{let s=Date.now();if(ey("Received a namespace status changed event ",{isLocked:e,waitTimeInMs:t,timestamp:i}),e&&t){this.isNamespaceLocked=!0,ey("Received a namespace status change event ",{isLocked:e}),setTimeout(()=>{ey("The namespace lock has expired",{waitTime:Date.now()-s,timestamp:i}),this.isNamespaceLocked=!1},t);return}this.isNamespaceLocked=!1,ey("The page lock has expired")}}}let eR=async(e,t)=>{let{sessionId:i,timestamp:s,clientId:r,userId:n,permit:a,presenceId:o,presenceActivity:c}=e,d=await t?.(n);return{name:d?.name||"",avatar:d?.avatar||"",email:d?.email||"",sessionId:i,lastActive:s,userId:n,clientId:r,permit:a,isGuest:d?.isGuest,presenceId:o,presenceActivity:c,isHydrated:!!d}},eT=async(e,t)=>{let{batchSize:i=25,getUsers:s}=t,r=e.getUniqueParticipants({isHydrated:!1}).splice(0,i);if(!r.length)return[];let n=new Set;r.forEach(e=>{n.add(e.userId)});let a=await s?.([...n.values()]),o=[];return a?.forEach(t=>{e.getParticipants().filter(e=>e.userId===t.userId).forEach(i=>{let{sessionId:s}=i,r={name:t.name,avatar:t.avatar,email:t.email,userId:t.userId,isGuest:t.isGuest,sessionId:s,lastActive:i.lastActive,clientId:i.clientId,permit:i.permit,presenceId:i.presenceId,presenceActivity:i.presenceActivity,isHydrated:!0};e.setBySessionId(s,r),o.push(r)})}),o};class eA{constructor(e=new Map){this.participants=void 0,this.getBySessionId=e=>{let t=this.participants.get(e);return t?{...t}:void 0},this.setBySessionId=(e,t)=>{this.participants.set(e,t)},this.getParticipants=()=>[...this.participants.values()].filter(e=>!(0,i("4frCv").isAIProviderID)(e.userId)).map(e=>({...e})),this.getAIProviderParticipants=()=>[...this.participants.values()].filter(e=>(0,i("4frCv").isAIProviderID)(e.userId)).map(e=>({...e})),this.getUniqueParticipants=({isHydrated:e=!1})=>{let t=new Map;return this.getParticipants().forEach(i=>{if(!!i.isHydrated===e){let e=t.get(i.userId);t.set(i.userId,e?{...e,lastActive:i.lastActive,sessionId:i.sessionId,presenceActivity:i.presenceActivity}:i)}}),[...t.values()]},this.hasMoreParticipantsToHydrate=()=>this.getUniqueParticipants({isHydrated:!1}).length>0,this.removeBySessionId=e=>this.participants.delete(e),this.clear=()=>this.participants.clear(),this.doesntHave=e=>!this.participants.has(e),this.size=()=>this.participants.size,this.getUniqueParticipantSize=()=>{let e=new Set;return this.getParticipants().forEach(t=>e.add(t.userId)),e.size},this.updateLastActive=(e,t)=>this.participants.forEach(i=>{i.lastActive=t.includes(i.userId)?e:i.lastActive}),this.participants=e}}let eO=(0,i("4frCv").createLogger)("PresenceService","pink"),e_="unidentified";class eN{emitTelepointersFromSteps(e){e.forEach(e=>{let t=K(this.participantsState.getParticipants(),e);t&&this.emitTelepointer(t,"emitting telepointers from steps")})}emitPresenceActivityChange(e,t){try{this.emit("presence:changed",e)}catch(e){this.analyticsHelper?.sendErrorEvent(e,`Error while ${t}`)}}constructor(e,t=new eA,s,r,n,a,o,c,d,h,l){this.analyticsHelper=e,this.participantsState=t,this.emit=s,this.getUser=r,this.batchProps=n,this.channelBroadcast=a,this.sendPresenceJoined=o,this.getPresenceData=c,this.setUserId=d,this.getAIProviderActiveIds=h,this.fetchAnonymousAsset=l,this.participantUpdateTimeout=void 0,this.presenceUpdateTimeout=void 0,this.presenceFetchTimeout=void 0,this.currentlyPollingFetchUsers=!0,this.hasBatchFetchError=!1,this.sendPresenceActivityChanged=()=>{this.sendPresence()},this.sendAIProviderChanged=e=>{if(e.providerId){for(let t in e.permit)e.permit.hasOwnProperty(t)&&(e.permit[t]=!1);let t=this.buildAIProviderPresencePayload(e.providerId);"add"===e.action?this.sendAIProviderParticipantUpdated(t):"remove"===e.action&&this.sendAIProviderParticipantLeft(t)}},this.buildAIProviderPresencePayload=e=>{let t=this.getPresenceData();return{sessionId:`${e}::${t.sessionId}`,userId:e,clientId:`${e}::${t.clientId}`,permit:{isPermittedToComment:!1,isPermittedToEdit:!1,isPermittedToView:!1},timestamp:Date.now()}},this.sendAIProviderParticipantUpdated=e=>{this.channelBroadcast("participant:updated",e)},this.sendAIProviderParticipantLeft=e=>{this.channelBroadcast("participant:left",e)},this.sendAIProvidersPresence=()=>{this.getAIProviderActiveIds&&this.getAIProviderActiveIds().forEach(e=>{let t=this.buildAIProviderPresencePayload(e);this.sendAIProviderParticipantUpdated(t)})},this.hasPresenceActivityChanged=(e,t)=>e.presenceActivity!==t.presenceActivity,this.handleAnonymousUser=async e=>{let t,{sessionId:i}=e,s=this.participantsState.getBySessionId(i),r=s?.name??"";if(!s&&this.fetchAnonymousAsset){try{t=await this.fetchAnonymousAsset(e.presenceId)}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while fetching anonymous assets")}r=t?.name??r}let n={...e,lastActive:e.timestamp,name:r,avatar:s?.avatar??t?.src??"",email:"",userId:e_,isHydrated:!0};this.participantsState.setBySessionId(i,n),this.emitPresence({joined:[n]},"handling updated anonymous participant")},this.updateParticipantEager=async e=>{let t,{userId:i}=e;if(!i||i===e_)return void await this.handleAnonymousUser(e);try{t=await eR({...e,userId:i},this.getUser)}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while enriching participant")}if(!t)return;let s=this.participantsState.getBySessionId(t.sessionId);if(this.participantsState.setBySessionId(t.sessionId,t),s){this.hasPresenceActivityChanged(s,t)&&this.emitPresenceActivityChange({type:"participant:activity",activity:t.presenceActivity},"handling participant activity changed event");return}this.emitPresence({joined:[t]},"handling participant updated event")},this.updateParticipantLazy=async e=>{let{userId:t,sessionId:s}=e;if(!t||t===e_)return void await this.handleAnonymousUser(e);let r=this.participantsState.getBySessionId(s);if(!r){let r={...e,lastActive:e.timestamp,name:"",avatar:"",email:"",userId:t};return(this.participantsState.setBySessionId(s,r),(0,i("4frCv").isAIProviderID)(t))?void this.emitPresence({joined:[r]},"handling updated new agent lazy"):(this.currentlyPollingFetchUsers||this.batchFetchUsers(),void(this.batchProps?.participantsLimit&&this.emitPresence({joined:[r]},"handling updated new participant lazy")))}let n={...r,presenceActivity:e.presenceActivity,lastActive:e.timestamp};this.hasPresenceActivityChanged(r,n)&&(this.participantsState.setBySessionId(s,n),this.emitPresenceActivityChange({type:"participant:activity",activity:n.presenceActivity},"handling participant activity changed event"))},this.onParticipantUpdated=async e=>{this.batchProps?this.updateParticipantLazy(e):await this.updateParticipantEager(e)},this.onParticipantLeft=e=>{let t=e.sessionId;e?.data?.sessionId&&(0,i("4frCv").isAIProviderID)(e.data.sessionId)?t=e.data.sessionId:this.getAIProviderParticipants().filter(e=>e.sessionId.endsWith(t)).forEach(i=>{this.onParticipantLeft({sessionId:t,timestamp:e.timestamp,data:i,userId:void 0,clientId:""})}),this.participantsState.removeBySessionId(t),this.emitPresence({left:[{sessionId:t}]},"participant leaving")},this.disconnect=(e,t)=>{let i=this.participantsState.getParticipants();this.participantsState.clear();try{this.emit("disconnected",{reason:H(e),sid:t})}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while emitting disconnected data")}i.length&&this.emitPresence({left:i},"emitting presence update on disconnect")},this.updateLastActive=(e=[])=>this.participantsState.updateLastActive(Date.now(),e),this.onParticipantTelepointer=(e,t)=>{let{sessionId:i,selection:s,timestamp:r}=e,n=this.participantsState.getBySessionId(i);if(i===t||n&&n.lastActive>r)return;let a=e.userId?[e.userId]:void 0;this.updateLastActive(a),this.emitTelepointer({type:"telepointer",selection:s,sessionId:i},"handling participant telepointer event")},this.startInactiveRemover=e=>{clearTimeout(this.participantUpdateTimeout);try{this.filterInactive(e)}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Failed filtering inactive participants")}this.participantUpdateTimeout=window.setTimeout(()=>this.startInactiveRemover(e),3e5)},this.enrichParticipants=async e=>{try{let t=await eT(this.participantsState,e);t.length&&this.emitPresence({joined:t},"handling participant updated event")}catch(t){e.onError?.(t),this.hasBatchFetchError=!0,this.analyticsHelper?.sendErrorEvent(t,"Failed while fetching participants")}},this.batchFetchUsers=async()=>{if(!this.batchProps)return;if(this.hasBatchFetchError){eO("Cannot continue to fetch users due to fetch error"),clearTimeout(this.presenceFetchTimeout);return}this.currentlyPollingFetchUsers=!0,clearTimeout(this.presenceFetchTimeout);let{debounceTime:e,participantsLimit:t}=this.batchProps;t?this.participantsState.getUniqueParticipants({isHydrated:!0}).length<t?(await this.enrichParticipants({...this.batchProps,batchSize:t}),this.currentlyPollingFetchUsers=this.participantsState.hasMoreParticipantsToHydrate()):this.currentlyPollingFetchUsers=!1:t||(await this.enrichParticipants(this.batchProps),this.currentlyPollingFetchUsers=this.participantsState.hasMoreParticipantsToHydrate()),this.currentlyPollingFetchUsers&&(this.presenceFetchTimeout=window.setTimeout(()=>this.batchFetchUsers(),e??500))},this.initializeFirstBatchFetchUsers=async()=>{await new Promise(e=>window.setTimeout(e,this.batchProps?.debounceTime??500)),this.batchFetchUsers()},this.filterInactive=e=>{let t=Date.now(),i=this.participantsState.getParticipants().filter(i=>i.sessionId!==e&&t-i.lastActive>3e5);i.forEach(e=>this.participantsState.removeBySessionId(e.sessionId)),i.length&&this.emitPresence({left:i},"filtering inactive participants")},this.emitPresence=(e,t)=>{try{this.emit("presence",e),this.analyticsHelper?.sendActionEvent(A.UPDATE_PARTICIPANTS,O.SUCCESS,{participants:this.participantsState.size()})}catch(e){this.analyticsHelper?.sendErrorEvent(e,`Error while ${t}`)}},this.emitTelepointer=(e,t)=>{try{this.emit("telepointer",e)}catch(e){this.analyticsHelper?.sendErrorEvent(e,`Error while ${t}`)}},this.clearTimers=()=>{clearTimeout(this.participantUpdateTimeout),clearTimeout(this.presenceFetchTimeout)},this.sendPresence=()=>{try{clearTimeout(this.presenceUpdateTimeout);let e=this.getPresenceData();this.channelBroadcast("participant:updated",e),this.presenceUpdateTimeout=window.setTimeout(()=>this.sendPresence(),15e4),this.sendAIProvidersPresence()}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while sending presence")}},this.onPresenceJoined=e=>{try{eO("Participant joined with session: ",e.sessionId),this.sendPresence()}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while joining presence")}},this.onPresence=e=>{try{eO("onPresence userId: ",e.userId),this.setUserId(e.userId),this.sendPresence(),this.sendPresenceJoined()}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while receiving presence")}},this.getParticipants=()=>this.participantsState.getParticipants(),this.getUniqueParticipantSize=()=>this.participantsState.getUniqueParticipantSize(),this.getUniqueParticipants=e=>this.participantsState.getUniqueParticipants(e),this.getAIProviderParticipants=()=>this.participantsState.getAIProviderParticipants(),this.getCollabMode=()=>this.participantsState.size()>1?"collab":"single"}}let eP=e=>{switch(e.data?.code){case x.HEAD_VERSION_UPDATE_FAILED:case x.VERSION_NUMBER_ALREADY_EXISTS:case F.ADD_STEPS_ERROR:case F.RECONNECTION_ERROR:case F.CONNECTION_ERROR:return;case x.INSUFFICIENT_EDITING_PERMISSION:case F.TOKEN_PERMISSION_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.NO_PERMISSION_ERROR,message:"User does not have permissions to access this document or document is not found",reason:e.data.meta.reason,recoverable:!0,status:403};case x.FORBIDDEN_USER_TOKEN:return{code:i("h3X17").PROVIDER_ERROR_CODE.INVALID_USER_TOKEN,message:"The user token was invalid",recoverable:!0,status:403};case F.DOCUMENT_NOT_FOUND:return{code:i("h3X17").PROVIDER_ERROR_CODE.DOCUMENT_NOT_FOUND,message:"The requested document is not found",recoverable:!0,status:404};case x.TENANT_INSTANCE_MAINTENANCE:return{code:i("h3X17").PROVIDER_ERROR_CODE.LOCKED,message:"The document is currently not available, please try again later",recoverable:!0,status:423};case x.LOCKED_DOCUMENT:return{code:i("h3X17").PROVIDER_ERROR_CODE.LOCKED,message:"The document is currently not available, please try again later",recoverable:!0};case x.DYNAMO_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.FAIL_TO_SAVE,message:"Collab service is not able to save changes",recoverable:!1,status:500};case F.DOCUMENT_RESTORE_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.DOCUMENT_RESTORE_ERROR,message:"Collab service unable to restore document",recoverable:!1,status:500};case x.INIT_DATA_LOAD_FAILED:return{code:i("h3X17").PROVIDER_ERROR_CODE.INITIALISATION_ERROR,message:"The initial document couldn't be loaded from the collab service",recoverable:!1,status:500};case x.PROSEMIRROR_SCHEMA_VALIDATION_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.INITIALISATION_ERROR,message:"The initial document couldn't be loaded from the collab service due to a prosemirror schema validation error",recoverable:!1};case F.DOCUMENT_UPDATE_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.DOCUMENT_UPDATE_ERROR,message:"The provider failed to apply changes to the editor",recoverable:!1,status:500};case F.RECONNECTION_NETWORK_ISSUE:return{code:i("h3X17").PROVIDER_ERROR_CODE.NETWORK_ISSUE,message:"Couldn't reconnect to the collab service due to network issues",recoverable:!0,status:500};case x.NAMESPACE_INVALID:case x.INVALID_ACTIVATION_ID:case x.INVALID_DOCUMENT_ARI:case x.INVALID_CLOUD_ID:return{code:i("h3X17").PROVIDER_ERROR_CODE.INVALID_PROVIDER_CONFIGURATION,message:"Invalid provider configuration",recoverable:!1,reason:e.data?.code,status:400};case x.NAMESPACE_NOT_FOUND:case x.ERROR_MAPPING_ERROR:case x.EMPTY_BROADCAST:case F.CATCHUP_FAILED:return{code:i("h3X17").PROVIDER_ERROR_CODE.INTERNAL_SERVICE_ERROR,message:"Collab Provider experienced an unrecoverable error",recoverable:!0,reason:e.data?.code,status:500};case x.RATE_LIMIT_ERROR:return{code:i("h3X17").PROVIDER_ERROR_CODE.FAIL_TO_SAVE,message:"Document rate limit",recoverable:!1};default:return}},ew=(0,i("4frCv").createLogger)("Api","blue");class eD extends Error{constructor(e,t,i){super(e),this.status=void 0,this.meta=void 0,this.name="AddCommentError",this.status=t,this.meta=i}}class eb{async addComment(e){let t=this.documentService.getCurrentPmVersion();try{let i=await this.submitComment(e,t),s=i.status,{message:r,meta:n}=await i.json();if(201===s)return ew(`NCS response: ${r}`),{message:r};if(s>=400&&s<=499)throw ew(`NCS error meta: ${JSON.stringify(n)}`),new eD(`Failed to add comment - Client error: ${r}`,s,JSON.stringify(n));throw new eD("Failed to add comment - Server error",s)}catch(e){if(e instanceof eD)throw e;throw Error(`Error submitting comment: ${e}`)}}constructor(e,t,s){this.config=void 0,this.documentService=void 0,this.channel=void 0,this.submitComment=async(e,t)=>{let s=JSON.stringify({productId:"ccollab",version:t,steps:e}),r=`${this.config.url}/document/${encodeURIComponent(this.config.documentAri)}/comment`;ew("Request url: ",r);let n=(0,i("lMdlY").getActiveTraceHttpRequestHeaders)(r),a={credentials:"include",headers:{...this.config.permissionTokenRefresh?{"x-token":await this.channel.getChannelToken()}:{},"x-product":(0,i("4frCv").getProduct)(this.config.productInfo),"x-subproduct":(0,i("4frCv").getSubProduct)(this.config.productInfo),"Content-Type":"application/json",...n},method:"POST",body:s};return await fetch(r,a)},this.config=e,this.documentService=t,this.channel=s}}class eU{async addComment(){}}function ek(e,t){if(e&&t&&e.length===t.length&&t.some(e=>e?.getMeta("isOffline")===!0||e?.getMeta("wasOffline")===!0))return e.filter((e,i)=>{let s=t[i];return!!s&&(s.getMeta("isOffline")||s.getMeta("wasOffline"))})}let eM=(0,i("4frCv").createLogger)("Provider","black");s.exports.MAX_STEP_REJECTED_ERROR=15,s.exports.MAX_STEP_REJECTED_ERROR_AGGRESSIVE=2,s.exports.Provider=class extends g{initialize(e){return this.setup({getState:e})}setup({getState:e,editorApi:t,onSyncUpError:s}){this.checkForCookies();try{let t=e().plugins.find(e=>"collab$"===e.key);if(void 0===t)throw new(0,i("ixa9X").ProviderInitialisationError)("Collab provider attempted to initialise, but Editor state is missing collab plugin");if(this.clientId=t.spec.config.clientID,this.clientId||(this.clientId=`temp-cp-${(0,E.v4)()}`),this.documentService.setup({getState:e,onSyncUpError:s,clientId:this.clientId}),this.isBufferingEnabled&&this.initialDraft&&!this.isProviderInitialized){let{document:e,version:t,metadata:i}=this.initialDraft;this.updateDocumentAndMetadata({doc:e,version:t,metadata:i,caller:"Provider.setup"}),this.analyticsHelper?.sendActionEvent(A.PROVIDER_INITIALIZED,O.INFO,{isBuffered:!0})}this.isChannelInitialized||(this.initializeChannel(),this.isChannelInitialized=!0)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while initialising the provider"),new(0,i("ixa9X").ProviderInitialisationError)("Provider initialisation error",e)}return this}setupForPresenceOnly(e){this.clientId=e,this.checkForCookies();try{this.isChannelInitialized||(this.initializeChannel(),this.isChannelInitialized=!0)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while initialising the provider"),new(0,i("ixa9X").ProviderInitialisationError)("Provider initialisation error",e)}return this}checkForCookies(){if(!e.navigator.cookieEnabled){let e=new(0,i("ixa9X").ProviderInitialisationError)("Cookies are not enabled. Please enable cookies to use collaborative editing.");throw this.analyticsHelper?.sendErrorEvent(e,"Error while initialising the provider - cookies disabled"),new(0,i("ixa9X").ProviderInitialisationError)("Provider initialisation error - cookies disabled",e)}}send(e,t,s){try{if(this.isViewOnly()){let e={message:"Attempted to send steps in view only mode",data:{code:F.VIEW_ONLY_STEPS_ERROR}};(0,i("4frCv").logObfuscatedSteps)(t,s).then(t=>{let s=t instanceof i("ixa9X").CustomError?{}:{...t},r=new(0,i("ixa9X").CustomError)(e.message,e,{...s});this.analyticsHelper?.sendErrorEvent(r,r.message)}).catch(e=>this.analyticsHelper?.sendErrorEvent(e,e.message));return}if(this.namespaceService.getIsNamespaceLocked())return void eM("The document is temporary locked");this.documentService.send(e,t,s)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while sending steps for a transaction"),new(0,i("ixa9X").SendTransactionError)("Error while sending steps for a transaction",e)}}isViewOnly(){return this.permit&&!1===this.permit.isPermittedToEdit&&!0===this.permit.isPermittedToView}sendMessage(e){let t={userId:this.userId,sessionId:this.sessionId,clientId:this.clientId,permit:this.permit};try{e?.type==="telepointer"?this.channel.broadcast("participant:telepointer",{...t,selection:e.selection},T()?Y(this.config.documentAri):void 0):e?.type==="ai-provider:change"?this.participantsService.sendAIProviderChanged({...t,...e}):e?.type==="participant:activity"&&(this.setPresenceActivity(e.activity),this.participantsService.sendPresenceActivityChanged())}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Error while sending message - telepointer")}}setAIProviderActiveIds(e=[]){this.aiProviderActiveIds=e}destroy(){return this.unsubscribeAll()}disconnect(){return this.unsubscribeAll()}unsubscribeAll(){try{super.unsubscribeAll(),this.channel.disconnect(),this.sendStepsTimer&&(clearInterval(this.sendStepsTimer),this.sendStepsTimer=void 0)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while shutting down the collab provider"),new(0,i("ixa9X").DestroyError)("Error while shutting down the collab provider",e)}return this.clearTimers(),this}setTitle(e,t){try{if(this.isViewOnly())return;this.metadataService.setTitle(e,t)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while setting title"),new(0,i("ixa9X").SetTitleError)("Error while setting title",e)}}setEditorWidth(e,t){try{this.metadataService.setEditorWidth(e,t)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while setting editor width"),new(0,i("ixa9X").SetEditorWidthError)("Error while setting editor width",e)}}setMetadata(e){try{if(this.isViewOnly())return;this.metadataService.setMetadata(e)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while setting metadata"),new(0,i("ixa9X").SetMetadataError)("Error while setting metadata",e)}}getIsNamespaceLocked(){return this.namespaceService.getIsNamespaceLocked()}constructor(e){super(),this.api=void 0,this.channel=void 0,this.config=void 0,this.analyticsHelper=void 0,this.isChannelInitialized=!1,this.initialDraft=void 0,this.isProviderInitialized=!1,this.isBuffered=!1,this.permit={isPermittedToView:!1,isPermittedToComment:!1,isPermittedToEdit:!1},this.isBufferingEnabled=!1,this.sessionId=void 0,this.clientId=void 0,this.userId=void 0,this.presenceId=void 0,this.presenceActivity=void 0,this.presenceUpdateTimeout=void 0,this.disconnectedAt=void 0,this.sendStepsTimer=void 0,this.participantsService=void 0,this.metadataService=void 0,this.documentService=void 0,this.namespaceService=void 0,this.aiProviderActiveIds=[],this.emitCallback=(e,t)=>this.emit(e,t),this.updateDocumentAndMetadata=({doc:e,version:t,metadata:i,caller:s})=>{try{this.documentService.updateDocument({doc:e,version:t,metadata:i,caller:s}),this.metadataService.updateMetadata(i),this.isProviderInitialized=!0}catch(e){this.analyticsHelper?.sendErrorEvent(e,"Failed to update with the init document, destroying provider"),this.destroy()}},this.initializeChannel=()=>{this.emit("connecting",{initial:!0});let e=!!this.initialDraft;this.channel.on("connected",({sid:e,initialized:t})=>{var s,r,n,a;this.sessionId=e,this.emit("connected",{sid:e,initial:!t});let o=this.documentService.getUnconfirmedSteps()?.length;if(this.isBufferingEnabled&&this.isProviderInitialized&&!this.isBuffered&&(this.isBuffered=!0,this.documentService.sendStepsFromCurrentState(!0)),this.initialDraft&&t&&!this.isProviderInitialized){let{document:e,version:t,metadata:i}=this.initialDraft;this.updateDocumentAndMetadata({doc:e,version:t,metadata:i,caller:"connectedHandler"})}if(t&&this.disconnectedAt&&Date.now()-this.disconnectedAt>=3e3&&this.documentService.throttledCatchupv2(N.RECONNECTED,{disconnectionPeriodSeconds:Math.floor((Date.now()-this.disconnectedAt)/1e3),offlineStepsLength:(0,B.editorExperiment)("platform_editor_offline_editing_web",!0)?(s=this.documentService.getUnconfirmedSteps(),r=this.documentService.getUnconfirmedStepsOrigins(),ek(s,r)?.length):void 0,offlineReplaceStepsLength:(0,B.editorExperiment)("platform_editor_offline_editing_web",!0)?(n=this.documentService.getUnconfirmedSteps(),a=this.documentService.getUnconfirmedStepsOrigins(),ek(n,a)?.filter(e=>e instanceof i("aXG5V").ReplaceStep).length):void 0,unconfirmedStepsLength:o},(0,i("dh538").fg)("add_session_id_to_catchup_query")?this.sessionId:void 0),this.participantsService.startInactiveRemover(this.sessionId),this.config.batchProps){if(this.config.getUser)throw new(0,i("ixa9X").ProviderInitialisationError)("Cannot supply getUser and batchProps together");this.participantsService.initializeFirstBatchFetchUsers()}this.disconnectedAt=void 0}).on("init",({doc:e,version:t,metadata:i})=>{this.updateDocumentAndMetadata({doc:e,version:t,metadata:i,caller:"initHandler"})}).on("restore",this.documentService.onRestore).on("permission",e=>{this.permit=Object.assign(this.permit,e),this.emit("permission",e)}).on("steps:added",this.documentService.onStepsAdded).on("metadata:changed",this.metadataService.onMetadataChanged).on("participant:telepointer",e=>this.participantsService.onParticipantTelepointer(e,this.sessionId)).on("presence:joined",this.participantsService.onPresenceJoined).on("presence",this.participantsService.onPresence).on("participant:left",this.participantsService.onParticipantLeft).on("participant:updated",this.participantsService.onParticipantUpdated).on("disconnect",this.onDisconnected.bind(this)).on("error",this.onErrorHandled).on("status",async e=>{await this.namespaceService.onNamespaceStatusChanged(e);let t=this.namespaceService.getIsNamespaceLocked();this.emit("namespace-lock:check",{isLocked:t})}).connect(e)},this.setUserId=e=>{this.userId=e},this.getPresenceData=()=>({sessionId:this.sessionId,userId:this.userId,clientId:this.clientId,permit:this.permit,presenceId:this.presenceId,presenceActivity:this.presenceActivity}),this.setPresenceActivity=e=>{this.presenceActivity=e},this.onErrorHandled=e=>{if(e.data?.code===x.HEAD_VERSION_UPDATE_FAILED||e.data?.code===x.VERSION_NUMBER_ALREADY_EXISTS)this.documentService.onStepRejectedError();else{this.analyticsHelper?.sendErrorEvent(e,e.message);let t=eP(e);t&&(this.analyticsHelper?.sendProviderErrorEvent(t),this.emit("error",t))}},this.getAIProviderActiveIds=()=>this.aiProviderActiveIds,this.onDisconnected=({reason:e})=>{this.disconnectedAt=Date.now(),this.participantsService.disconnect(e,this.sessionId)},this.getMetadata=()=>this.metadataService.getMetaData(),this.getCurrentState=async()=>{try{return await this.documentService.getCurrentState()}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while returning ADF version of current draft document"),new(0,i("ixa9X").GetCurrentStateError)("Error while returning the current state of the draft document",e)}},this.getFinalAcknowledgedState=async e=>{try{return await this.documentService.getFinalAcknowledgedState(e)}catch(e){throw this.analyticsHelper?.sendErrorEvent(e,"Error while returning ADF version of the final draft document"),new(0,i("ixa9X").GetFinalAcknowledgedStateError)("Error while returning the final acknowledged state of the draft document",e)}},this.getUnconfirmedSteps=()=>this.documentService.getUnconfirmedSteps(),this.getCurrentPmVersion=()=>this.documentService.getCurrentPmVersion(),this.clearTimers=()=>{clearTimeout(this.presenceUpdateTimeout),this.participantsService.clearTimers()},this.getParticipants=()=>this.participantsService.getParticipants(),this.getUniqueParticipantSize=()=>this.participantsService.getUniqueParticipantSize(),this.getUniqueParticipants=()=>this.participantsService.getUniqueParticipants({isHydrated:!1}),this.getUniqueHydratedParticipants=()=>this.participantsService.getUniqueParticipants({isHydrated:!0}),this.getAIProviderParticipants=()=>this.participantsService.getAIProviderParticipants(),this.fetchMore=async e=>{if(this.config.batchProps)await this.participantsService.enrichParticipants({...this.config.batchProps,batchSize:e?.fetchSize??this.config.batchProps.batchSize});else throw Error("Must provide batch properties to use fetchMore")},this.getSessionId=()=>this.sessionId,this.getDocumentAri=()=>this.config.documentAri,this.config=e,this.analyticsHelper=new G(this.config.documentAri,this.config.productInfo?.subProduct,this.config.analyticsClient,this.config.getAnalyticsWebClient),this.channel=new z(e,this.analyticsHelper),this.isChannelInitialized=!1,this.initialDraft=this.config.initialDraft,this.isBufferingEnabled=!!this.config.isBufferingEnabled,this.isProviderInitialized=!1,this.participantsService=new eN(this.analyticsHelper,void 0,this.emitCallback,this.config.getUser,this.config.batchProps,this.channel.broadcast,this.channel.sendPresenceJoined,this.getPresenceData,this.setUserId,this.getAIProviderActiveIds,this.config.fetchAnonymousAsset),this.metadataService=new Q(this.emitCallback,this.channel.sendMetadata),this.namespaceService=new eC,this.presenceId=this.config.presenceId,this.presenceActivity=this.config.presenceActivity,e.isPresenceOnly?(this.documentService=new eI,this.api=new eU):(this.documentService=new ev(this.participantsService,this.analyticsHelper,this.channel.fetchCatchupv2,this.channel.fetchReconcile,this.channel.fetchGeneratedDiffSteps,this.emitCallback,this.channel.broadcast,()=>this.userId,this.onErrorHandled,this.metadataService,this.namespaceService.getIsNamespaceLocked.bind(this.namespaceService),this.config.enableErrorOnFailedDocumentApply,{__livePage:this.config.__livePage||!1},this.channel.getConnected),this.api=new eb(e,this.documentService,this.channel)),this.sendStepsTimer=setInterval(()=>{eM("Intervally sendStepsFromCurrentState"),this.documentService.sendStepsFromCurrentState(!0,void 0)},5e3)}}}),s("4frCv",function(e,t){let s="Lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua Ut enim ad minim veniam quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur Excepteur sint occaecat cupidatat non proident sunt in culpa qui officia deserunt mollit anim id est laborum",r=["2","7","4","3","5","9","1","8","0","5"],n={bodiedExtension:["extensionKey","extensionType","layout"],codeBlock:["language"],decisionItem:["state"],embedCard:["layout","originalHeight","originalWidth","width"],extension:["extensionKey","extensionType","layout","type"],heading:["level"],inlineExtension:["extensionKey","extensionType","layout"],layoutColumn:["width"],media:["__fileMimeType","__fileSize","height","width","type"],mediaSingle:["layout","width","widthType"],orderedList:["order"],panel:["panelType"],status:["color","style"],table:["isNumberColumnEnabled","layout","width"],tableCell:["background","colspan","colwidth","defaultMarks","rowspan"],tableHeader:["background","colspan","colwidth","defaultMarks","rowspan"],tableRow:["defaultMarks"],taskItem:["state"],blockTaskItem:["state"]},a=e=>[...e].reduce((e,[t,i])=>(e[t]=i,e),{}),o=(e,t=0)=>parseInt(e.toString().split("").map((e,i)=>{let s=r.length-1;return r[(t+i)%s]}).join(""),10),c=(e,t=0)=>{let r=s.repeat(Math.ceil((t+e.length)/s.length));return[...e].map((e,s,n)=>{if(RegExp("^\\p{Nd}$","u").test(e))return o(parseInt(e,10),s).toString();{if(RegExp("^\\p{So}$","u").test(e))return n[s-1]?.codePointAt(0)===8205?"":"";if(RegExp("^\\p{Sc}$","u").test(e))return"$";if(RegExp("^[\\p{P}\\p{Z}\\p{C}]$","u").test(e))return e;if(65039===e.codePointAt(0)&&RegExp("^\\p{So}$","u").test(n[s-1]))return"";let a=+(" "===r[t%r.length]),o=(0,i("dh538").fg)("platform_adf-utils_fix-dummy-text-index-oob")?r[(t+a)%r.length]:r[t+a],c=e.toLowerCase()===e?o.toLowerCase():o.toUpperCase();return t+=1+a,c}}).join("")},d=(e,{valueReplacements:t})=>e.map(e=>"link"===e.type&&e.attrs.href?{...e,attrs:{...e.attrs,href:t.href(e.attrs.href)}}:e),h=(e,t)=>a(Object.entries(t).map(([t,i])=>n[e]?.includes(t)?[t,i]:[t,l(e,i)])),l=(e,t,i=0)=>{if("number"==typeof t)return o(t,i);if("string"==typeof t)return c(t,i);if("boolean"==typeof t||!t)return t;if(t&&t.constructor===Object&&0===Object.keys(t).length)return{};if("object"==typeof t&&!Array.isArray(t))return h(e,t);if(Array.isArray(t))return t.map(t=>"object"==typeof t?h(e,t):l(e,t));throw TypeError(`scrubAttrs: encountered unsupported attributes type "${typeof t}"
    of value ${JSON.stringify(t)}`)},p=(e,{valueReplacements:t})=>({type:e.type,attrs:{...e.attrs||{},url:t.href(e.attrs?.url)}}),u=e=>({type:e.type,attrs:e.attrs?l(e.type,e.attrs):void 0,content:e.content?.filter(e=>e?.type==="media")}),m={emoji:()=>({type:"emoji",attrs:{shortName:":blue_star:",id:"atlassian-blue_star",text:":blue_star:"}}),date:()=>({type:"date",attrs:{timestamp:new Date("2020-01-01").getTime()}}),mention:()=>({type:"mention",attrs:{id:"error:NotFound",text:"@Nemo",accessLevel:"CONTAINER"}}),inlineCard:p,blockCard:p,mediaSingle:u,mediaGroup:u,media:(e,{parent:t})=>{let i=t.node?.type==="mediaSingle"?{width:600,height:400}:{width:150,height:125},s=e.attrs?.width??i.width,r=e.attrs?.height??i.height;return{type:"media",attrs:{...l("media",e.attrs),type:"external",url:`https://dummyimage.com/${s}x${r}/f4f5f7/a5adba`}}}},E=e=>{let t=5381,i=e.length;for(;i>0;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()},S={href:e=>`https://hello.atlassian.net/wiki/spaces/ET/pages/968692273?${E(e)}`};var g=(e,t={})=>{let s={...m,...t.nodeReplacements},r={...S,...t.valueReplacements};return(0,i("6jPem").traverse)(e,{any:(e,t)=>{let i=s[e.type];if("function"==typeof i){let s=i(e,{parent:t,valueReplacements:r});if(!1!==s)return s}let n={};return Object.entries(e).forEach(([e,t])=>{["version","type","content","marks"].includes(e)&&(n[e]=t)}),e.text&&e.marks&&(n.marks=d(e.marks??[],{valueReplacements:r})),e.text&&(n.text=c(e.text)),e.attrs&&(n.attrs=l(e.type,e.attrs)),n}})},f=i("iA9co").Buffer;let v=e=>"override-document"===e.stepType&&"nextDocument"in e,I=e=>"addMark"===e.stepType||"addNodeMark"===e.stepType,y=e=>"setAttrs"===e.stepType&&"attrs"in e,C=e=>"batchAttrs"===e.stepType&&"data"in e,R=e=>"from"in e&&"number"==typeof e.from&&"to"in e&&"number"==typeof e.to,T=e=>"gapFrom"in e&&"number"==typeof e.gapFrom&&"gapTo"in e&&"number"==typeof e.gapTo,A=e=>"insert"in e&&"number"==typeof e.insert,O=e=>"pos"in e&&"number"==typeof e.pos,_=e=>"slice"in e&&Array.isArray(e.slice?.content),N=e=>{let t=null;return _(e)&&(t=e.slice.content.map(e=>e?.type||"unknown").join(", ")),{type:e.stepType||"unknown",contentTypes:t}},P=e=>{let t=U(e);return t?t.map(e=>g(e)).filter(e=>!!e):null},w=e=>({...R(e)&&{from:e.from,to:e.to},...T(e)&&{gapFrom:e.gapFrom,gapTo:e.gapTo},...A(e)&&{insert:e.insert},...O(e)&&{pos:e.pos}}),D=e=>e.metadata,b=(e,t)=>e.slice(0,t).map(e=>({stepType:N(e),stepContent:P(e),stepPositions:w(e),stepMetadata:D(e)})),U=e=>{if(_(e))return[{type:"doc",content:e.slice.content.filter(e=>null!==e)}];if(v(e))return[{type:"doc",content:e.nextDocument.content}];if(I(e)&&e.mark)return[{type:"doc",marks:[{type:e.mark.type||"unknown",attrs:e.mark.attrs}]}];if(y(e))return[{type:"doc",attrs:e.attrs}];if(C(e))return e.data.map(e=>({type:"doc",attrs:e.attrs}));return[]};async function k(e,t){try{let s="",r="",n={old:e?(0,i("9NwnH").sendableSteps)(e):null,new:(0,i("9NwnH").sendableSteps)(t)};return n.new?.steps&&(r=await M(n.new.steps)),n.old?.steps&&(s=await M(n.old.steps)),{stepsFromOldState:s,stepsFromNewState:r}}catch(e){return new(0,i("ixa9X").CustomError)("Failed to obfuscate steps",e)}}async function M(e){return JSON.stringify(b(await Promise.resolve(e.slice().map(e=>e.toJSON()))))}e.exports.createLogger=(e,t="blue")=>(i,s=null)=>{window.COLLAB_PROVIDER_LOGGER&&console.log(`%cCollab-${e}: ${i}`,`color: ${t}; font-weight: bold`,s)},e.exports.sleep=function(e){return new Promise(t=>{setTimeout(t,e)})},e.exports.isAIProviderID=e=>"string"==typeof e&&e.startsWith("agent:"),e.exports.getProduct=e=>e?.product??"unknown",e.exports.getSubProduct=e=>e?.subProduct??(e?.product?"none":"unknown"),e.exports.getStepUGCFreeDetails=e=>{let t;try{t=e.toJSON()}catch(t){return{type:"unknown",contentTypes:"",stepSizeInBytes:f.byteLength(JSON.stringify(e))}}let i="";return t.slice?.content&&Array.isArray(t.slice?.content)&&(i=t.slice.content.map(e=>e?.type||"unknown").join(", ")),{type:t.stepType||"unknown",contentTypes:i,stepSizeInBytes:f.byteLength(JSON.stringify(e))}},e.exports.getDocAdfWithObfuscation=e=>{let t=g(e.toJSON());return t||null},e.exports.getDocAdfWithObfuscationFromJSON=e=>{let t=g(e);return t||null},e.exports.getObfuscatedSteps=b,e.exports.logObfuscatedSteps=k}),s("ixa9X",function(e,t){class i extends Error{toJSON(){return{name:this.name,message:this.message}}constructor(e,t,i){super(e),this.extraEventAttributes=void 0,this.getExtraErrorEventAttributes=()=>this.extraEventAttributes,"string"==typeof t?.message&&(this.message=t.message),i&&(this.extraEventAttributes=i)}}e.exports.CustomError=i,e.exports.NotConnectedError=class extends i{constructor(...e){super(...e),this.name="NotConnectedError"}},e.exports.NotInitializedError=class extends i{constructor(...e){super(...e),this.name="NotInitializedError"}},e.exports.ProviderInitialisationError=class extends i{constructor(...e){super(...e),this.name="ProviderInitialisationError"}},e.exports.SendTransactionError=class extends i{constructor(...e){super(...e),this.name="SendTransactionError"}},e.exports.DestroyError=class extends i{constructor(...e){super(...e),this.name="DestroyError"}},e.exports.SetTitleError=class extends i{constructor(...e){super(...e),this.name="SetTitleError"}},e.exports.SetEditorWidthError=class extends i{constructor(...e){super(...e),this.name="SetEditorWidthError"}},e.exports.SetMetadataError=class extends i{constructor(...e){super(...e),this.name="SetMetadataError"}},e.exports.GetCurrentStateError=class extends i{constructor(...e){super(...e),this.name="GetCurrentStateError"}},e.exports.GetFinalAcknowledgedStateError=class extends i{constructor(...e){super(...e),this.name="GetFinalAcknowledgedStateError"}},e.exports.UpdateDocumentError=class extends i{constructor(e,t){super(e,void 0,t),this.name="UpdateDocumentError"}},e.exports.CantSyncUpError=class extends i{constructor(e,t){super(e,void 0,t),this.name="CantSyncUpError"}}});
//# sourceMappingURL=NativeCollabComponent.96d7d6fb.js.map
